# 海量场景下的分布式限流


本质是在一致性和可用性之间的权衡，高配额的限流场景例如服务QPS等可以采用非精准的限流策略，使用最终一致达到限流即可。
而如业务侧的各种限流比如一件物品一个人只能领一次或者一天只能发一次评论就需要精准限流，不能有误差。


由于同步存在，会有超限的可能
### 秒杀、热点商品的限流(QPS > 1w)
-  一致性hash到对应的限流机器，退化成单机限流
-  本地LRU淘汰过期的限流窗口

优化点: 上述内存问题解决了，但是每个窗口都单独上报
- 对hash到同一节点的窗口批量上报

## 防刷场景

# 限流模式
## 单次分配 强一致
- 精准限流，会增加业务延迟
## 批次分配  最终一致
- 准确性会降低
- 预测结算后消费，本地限流，会有误限的风险
- 先消费后结算， 能解决误限的问题，超限可控
- 一般都是客户端(LRU窗口)限流 + 客户端定期上报(ms级)配额到限流器 + 限流器响应客户端剩余配额，客户端重新计算限流额


## 限流策略
- 多级限流(网关层、应用层、服务层、数据层)
- 动态阈值调整(负载高降低权重)
- 多级维度(ip,设备) + 业务侧规则(发评限制)
